# =====================================================
# PROJECT: StarNote-like Drawing App + pub.dev Library
# OWNER: Ä°lyas AktaÅŸ
# TOOLS: Cursor IDE (Implementer) + Claude Opus (Architect)
# =====================================================

# -----------------------------------------------------
# PHASE STATUS (UPDATED: 2025-01-13)
# -----------------------------------------------------
- Phase 0: COMPLETE âœ… (Scaffolding)
- Phase 1: COMPLETE âœ… (UI Skeleton)
- Phase 2: COMPLETE âœ… (Drawing Core)
- Phase 3: COMPLETE âœ… (Canvas Integration)
- Phase 4: NOT STARTED âŒ (Advanced Features)
- Phase 5: NOT STARTED (Multi-Page & PDF)

Current Branch: main (Phase 4 branch oluÅŸturulacak)

# -----------------------------------------------------
# PHASE 4 PRIORITY DOCUMENTS (READ FIRST!)
# -----------------------------------------------------
Before writing ANY code, read these documents IN ORDER:

1. docs/PHASE4_MASTER_PLAN.md - Overall plan and architecture
2. docs/PHASE4_CURSOR_INSTRUCTIONS.md - Step-by-step tasks
3. docs/PHASE4_ERASER_SPEC.md - Eraser detailed specification
4. docs/PHASE4_SELECTION_SPEC.md - Selection detailed specification
5. docs/PHASE4_SHAPES_SPEC.md - Shapes detailed specification
6. docs/PHASE4_PERFORMANCE_RULES.md - Performance rules

# -----------------------------------------------------
# PHASE 4 STRUCTURE
# -----------------------------------------------------

## Modules (IN ORDER)
```
Phase 4A: Eraser System     (7 steps)  â† FIRST
Phase 4B: Selection System  (9 steps)
Phase 4C: Shape Tools       (6 steps)
Phase 4D: Text Tool         (OPTIONAL)
```

## Current Step
Check docs/PHASE4_CURSOR_INSTRUCTIONS.md for current step.

# -----------------------------------------------------
# PHASE 4 PACKAGE CHANGES
# -----------------------------------------------------

## drawing_core (NEW additions)
```
lib/src/
â”œâ”€â”€ hit_testing/           â† NEW FOLDER
â”‚   â”œâ”€â”€ hit_tester.dart
â”‚   â””â”€â”€ stroke_hit_tester.dart
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ shape.dart         â† NEW
â”‚   â”œâ”€â”€ shape_type.dart    â† NEW
â”‚   â””â”€â”€ selection.dart     â† NEW
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ eraser_tool.dart   â† NEW
â”‚   â”œâ”€â”€ lasso_selection_tool.dart  â† NEW
â”‚   â”œâ”€â”€ rect_selection_tool.dart   â† NEW
â”‚   â”œâ”€â”€ shape_tool.dart    â† NEW (abstract)
â”‚   â”œâ”€â”€ line_tool.dart     â† NEW
â”‚   â”œâ”€â”€ rectangle_tool.dart â† NEW
â”‚   â”œâ”€â”€ ellipse_tool.dart  â† NEW
â”‚   â””â”€â”€ arrow_tool.dart    â† NEW
â””â”€â”€ history/
    â”œâ”€â”€ erase_strokes_command.dart â† NEW
    â”œâ”€â”€ move_selection_command.dart â† NEW
    â”œâ”€â”€ delete_selection_command.dart â† NEW
    â”œâ”€â”€ add_shape_command.dart â† NEW
    â””â”€â”€ remove_shape_command.dart â† NEW
```

## drawing_ui (NEW additions)
```
lib/src/
â”œâ”€â”€ canvas/
â”‚   â”œâ”€â”€ shape_painter.dart     â† NEW
â”‚   â”œâ”€â”€ selection_painter.dart â† NEW
â”‚   â””â”€â”€ eraser_cursor_painter.dart â† NEW (optional)
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ eraser_provider.dart   â† NEW
â”‚   â”œâ”€â”€ selection_provider.dart â† NEW
â”‚   â””â”€â”€ shape_provider.dart    â† NEW
â””â”€â”€ widgets/
    â””â”€â”€ selection_handles.dart â† NEW
```

# -----------------------------------------------------
# âš¡ PERFORMANCE RULES (CRITICAL!)
# -----------------------------------------------------

## Phase 3 Rules (STILL APPLY!)
1. Two-layer rendering (committed vs active)
2. NO setState for drawing - use ChangeNotifier
3. NO allocation in paint()
4. Optimize shouldRepaint
5. Use RepaintBoundary

## Phase 4 Additional Rules

### P4-1: Hit Testing Performance
```dart
// âœ… ALWAYS use bounding box pre-filter
if (!_boundsCheck(stroke.bounds, x, y, tolerance)) {
  continue;  // Skip expensive segment check
}
```

### P4-2: Selection Rendering
```dart
// âœ… Selection in SEPARATE RepaintBoundary
RepaintBoundary(
  child: SelectionPainter(...),
)
```

### P4-3: Shape Path Caching
```dart
// âœ… Cache path, don't rebuild every frame
Path get path => _cachedPath ??= _buildPath();
```

### P4-4: Command Batching
```dart
// âœ… One command per gesture, not per point
void onPointerUp() {
  execute(EraseStrokesCommand(allErasedIds));
}
```

# -----------------------------------------------------
# HIT TESTING ALGORITHM
# -----------------------------------------------------

## Bounding Box Pre-filter (MANDATORY)
```
1. Check if point is within stroke bounds + tolerance
2. If outside â†’ SKIP (90%+ strokes eliminated here)
3. If inside â†’ Do segment distance check
```

## Point-to-Segment Distance
```dart
// See PHASE4_ERASER_SPEC.md for full algorithm
double pointToSegmentDistance(px, py, x1, y1, x2, y2) {
  // Project point onto line segment
  // Calculate perpendicular distance
}
```

# -----------------------------------------------------
# RENDERING LAYERS (Phase 4 Updated)
# -----------------------------------------------------

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 5: Selection Overlay              â”‚ â† NEW
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Active Shape Preview           â”‚ â† NEW
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Active Stroke                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Committed (Strokes + Shapes)   â”‚ â† UPDATED
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: Background/Grid                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

# -----------------------------------------------------
# FORBIDDEN ACTIONS
# -----------------------------------------------------

- âŒ setState in pointer handlers
- âŒ Allocation in paint()
- âŒ shouldRepaint => true
- âŒ No RepaintBoundary
- âŒ Hit test without bounds check
- âŒ Command per pointer move
- âŒ Path rebuild every frame
- âŒ Skipping specification documents
- âŒ Modifying Phase 3 code without reason

# -----------------------------------------------------
# ALLOWED ACTIONS
# -----------------------------------------------------

- âœ… ChangeNotifier/ValueNotifier
- âœ… ListenableBuilder
- âœ… Cached Paint/Path objects
- âœ… RepaintBoundary isolation
- âœ… Bounding box pre-filter
- âœ… Command batching
- âœ… Following spec documents exactly

# -----------------------------------------------------
# COMMIT WORKFLOW
# -----------------------------------------------------

After each step:
1. Run: flutter analyze (0 errors)
2. Run: flutter test (all pass)
3. List modified files
4. Propose commit message
5. WAIT for approval

Commit format:
```
feat(core): short description   # for drawing_core
feat(ui): short description     # for drawing_ui
```

# -----------------------------------------------------
# COMMUNICATION FORMAT
# -----------------------------------------------------

After EVERY task:

```
ðŸ“ Files Created/Modified:
- path/to/file.dart (created/modified)

ðŸ§ª Test Results:
- flutter analyze: âœ…/âŒ
- flutter test: âœ… X tests passed

âš¡ Performance Check:
- Bounds check used: âœ…/âŒ
- Path cached: âœ…/âŒ
- Command batched: âœ…/âŒ

ðŸ“ Suggested Commit:
feat(core/ui): description

Ready to commit? (y/n)
```

# -----------------------------------------------------
# QUICK REFERENCE: Phase 4 Steps
# -----------------------------------------------------

## Phase 4A: Eraser System
| # | Step | Status |
|---|------|--------|
| 4A-1 | Hit Testing Infrastructure | âŒ |
| 4A-2 | StrokeHitTester | âŒ |
| 4A-3 | EraserTool (stroke mode) | âŒ |
| 4A-4 | EraseStrokesCommand | âŒ |
| 4A-5 | Eraser Provider | âŒ |
| 4A-6 | DrawingCanvas Integration | âŒ |
| 4A-7 | Test & Polish | âŒ |

## Phase 4B: Selection System
| # | Step | Status |
|---|------|--------|
| 4B-1 | Selection Model | âŒ |
| 4B-2 | SelectionTool Abstract | âŒ |
| 4B-3 | LassoSelectionTool | âŒ |
| 4B-4 | RectSelectionTool | âŒ |
| 4B-5 | Selection Commands | âŒ |
| 4B-6 | SelectionProvider | âŒ |
| 4B-7 | SelectionPainter | âŒ |
| 4B-8 | SelectionHandles Widget | âŒ |
| 4B-9 | DrawingCanvas Integration | âŒ |

## Phase 4C: Shape Tools
| # | Step | Status |
|---|------|--------|
| 4C-1 | Shape Model | âŒ |
| 4C-2 | Layer Model Update | âŒ |
| 4C-3 | ShapeTool + Concrete Tools | âŒ |
| 4C-4 | Shape Commands | âŒ |
| 4C-5 | ShapePainter | âŒ |
| 4C-6 | Integration | âŒ |

# -----------------------------------------------------
# PHASE 4 GOAL
# -----------------------------------------------------

Add advanced drawing features:
- Eraser (stroke mode)
- Selection (lasso + rectangle)
- Shapes (line, rectangle, ellipse, arrow)

All with full undo/redo support.

Quality > Speed.
Performance is NON-NEGOTIABLE.
Follow specifications EXACTLY.
