# =====================================================
# PROJECT: StarNote-like Drawing App + pub.dev Library
# OWNER: Ä°lyas AktaÅŸ
# TOOLS: Cursor IDE (Implementer) + Claude Opus (Architect)
# =====================================================

# -----------------------------------------------------
# PHASE STATUS (UPDATED: 2025-01-13)
# -----------------------------------------------------
- Phase 0: COMPLETE âœ… (Scaffolding, Architecture)
- Phase 1: COMPLETE âœ… (UI Skeleton)
- Phase 2: COMPLETE âœ… (Drawing Core)
- Phase 3: IN PROGRESS ðŸ”„ (Canvas Integration)
- Phase 4: NOT STARTED (Advanced Features)

Current Branch: feature/phase3-canvas-integration

# -----------------------------------------------------
# PHASE 3 PRIORITY DOCUMENTS (READ FIRST!)
# -----------------------------------------------------
Before writing ANY code, read these documents:

1. docs/PHASE3_MASTER_PLAN.md - Overall plan and architecture
2. docs/PHASE3_CURSOR_INSTRUCTIONS.md - Step-by-step tasks
3. docs/PHASE3_PERFORMANCE_RULES.md - CRITICAL performance rules
4. docs/PHASE3_QUALITY_STANDARDS.md - Rendering quality rules

# -----------------------------------------------------
# PHASE 3 SPECIFIC RULES
# -----------------------------------------------------

## Current Step: Check PHASE3_CURSOR_INSTRUCTIONS.md

## Package Boundaries
- MODIFY: packages/drawing_ui/ (Phase 3 work here)
- IMPORT: packages/drawing_core/ (Phase 2 - don't modify)
- UPDATE: example_app/ (for testing)

# -----------------------------------------------------
# âš¡ PERFORMANCE RULES (CRITICAL!)
# -----------------------------------------------------

## RULE 1: Two-Layer Rendering
```dart
// CommittedStrokes: rarely repaints
// ActiveStroke: repaints every frame
Stack(
  children: [
    RepaintBoundary(child: CommittedStrokesPainter(...)),
    RepaintBoundary(child: ActiveStrokePainter(...)),
  ],
)
```

## RULE 2: NO setState for Drawing!
```dart
// âŒ FORBIDDEN
onPointerMove: (e) => setState(() { points.add(e); });

// âœ… REQUIRED
onPointerMove: (e) => _controller.addPoint(e);
// Use ChangeNotifier â†’ only painter repaints
```

## RULE 3: No Allocation in paint()
```dart
// âŒ FORBIDDEN
void paint(Canvas c, Size s) {
  final paint = Paint();  // NEW OBJECT EVERY FRAME!
}

// âœ… REQUIRED
final _paint = Paint();  // Cached
void paint(Canvas c, Size s) {
  c.drawPath(path, _paint);
}
```

## RULE 4: Optimize shouldRepaint
```dart
// âŒ FORBIDDEN
bool shouldRepaint(_) => true;  // ALWAYS REPAINTS!

// âœ… REQUIRED
bool shouldRepaint(Old old) => old._count != _count;
```

## RULE 5: Use RepaintBoundary
Every rendering layer must be isolated with RepaintBoundary.

# -----------------------------------------------------
# ðŸŽ¨ QUALITY RULES
# -----------------------------------------------------

## RULE 1: Vector-First Rendering
- Store strokes as Path (vector), not Image (raster)
- Zoom = re-render from vector = always sharp

## RULE 2: Device Pixel Ratio
- Account for Retina/HiDPI displays
- Cache at higher resolution

## RULE 3: Anti-Aliasing Always ON
```dart
Paint()..isAntiAlias = true  // ALWAYS!
```

## RULE 4: Smooth Curves
- Use Quadratic Bezier for stroke paths
- No jagged lines

## RULE 5: Text Always Vector
- Use TextPainter, not bitmap text
- Clear at any zoom level

# -----------------------------------------------------
# TARGET METRICS
# -----------------------------------------------------

| Metric | Target | Unacceptable |
|--------|--------|--------------|
| Frame time | <8ms | >16ms |
| Input latency | <16ms | >32ms |
| FPS | 60 | <30 |
| Zoom quality | Sharp | Pixelated |

# -----------------------------------------------------
# FILE STRUCTURE (Phase 3)
# -----------------------------------------------------

```
packages/drawing_ui/lib/src/
â”œâ”€â”€ canvas/
â”‚   â”œâ”€â”€ drawing_canvas.dart     â† Main widget
â”‚   â”œâ”€â”€ stroke_painter.dart     âœ… Done
â”‚   â””â”€â”€ mock_canvas.dart        (keep for reference)
â”œâ”€â”€ rendering/
â”‚   â””â”€â”€ flutter_stroke_renderer.dart  âœ… Done
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ drawing_providers.dart  â† Update
â”‚   â”œâ”€â”€ document_provider.dart  â† New
â”‚   â””â”€â”€ history_provider.dart   â† New
â””â”€â”€ controllers/
    â””â”€â”€ drawing_controller.dart â† From stroke_painter
```

# -----------------------------------------------------
# COMMIT WORKFLOW
# -----------------------------------------------------

After each step:
1. Run: flutter analyze (0 errors)
2. Run: flutter test (all pass)
3. List modified files
4. Propose commit message
5. WAIT for approval

Commit format:
```
feat(ui): short description

- Detail 1
- Detail 2
```

# -----------------------------------------------------
# TESTING RULES
# -----------------------------------------------------

Every new file needs tests:
- Unit tests for logic
- Widget tests for UI
- Performance tests for critical paths

Test location: test/ mirrors lib/src/

# -----------------------------------------------------
# FORBIDDEN ACTIONS
# -----------------------------------------------------

- âŒ setState in pointer handlers
- âŒ Allocation in paint()
- âŒ shouldRepaint => true
- âŒ No RepaintBoundary
- âŒ Bitmap-based zoom
- âŒ Modifying drawing_core
- âŒ Skipping tests
- âŒ Committing without approval

# -----------------------------------------------------
# ALLOWED ACTIONS
# -----------------------------------------------------

- âœ… ChangeNotifier/ValueNotifier
- âœ… ListenableBuilder
- âœ… Cached Paint objects
- âœ… RepaintBoundary isolation
- âœ… Vector (Path) rendering
- âœ… Importing drawing_core
- âœ… Updating providers

# -----------------------------------------------------
# COMMUNICATION FORMAT
# -----------------------------------------------------

After EVERY task:

```
ðŸ“ Files Created/Modified:
- path/to/file.dart (created/modified)

ðŸ§ª Test Results:
- flutter analyze: âœ…/âŒ
- flutter test: âœ… X tests passed

âš¡ Performance Check:
- setState in pointer handlers: âŒ None
- Allocation in paint(): âŒ None
- RepaintBoundary used: âœ… Yes

ðŸ“ Suggested Commit:
feat(ui): description

Ready to commit? (y/n)
```

# -----------------------------------------------------
# QUICK REFERENCE: Phase 3 Steps
# -----------------------------------------------------

| # | Step | Status |
|---|------|--------|
| 1 | Branch + Structure | âœ… |
| 2 | FlutterStrokeRenderer | âœ… |
| 3 | StrokePainter + Controller | âœ… |
| 4 | DrawingCanvas Basic | âŒ |
| 5 | Gesture Handling | âŒ |
| 6 | Live Stroke Preview | âŒ |
| 7 | DocumentProvider | âŒ |
| 8 | HistoryProvider | âŒ |
| 9 | Tool Integration | âŒ |
| 10 | Undo/Redo Buttons | âŒ |
| 11 | Zoom/Pan Support | âŒ |
| 12 | Final Integration | âŒ |

Current: Step 4

See docs/PHASE3_CURSOR_INSTRUCTIONS.md for details.

# -----------------------------------------------------
# PHASE 3 GOAL
# -----------------------------------------------------

Transform the mock canvas into a real drawing canvas.
User touches screen â†’ real strokes appear â†’ undo/redo works.

Quality > Speed.
Performance is NON-NEGOTIABLE.
60 FPS or nothing.
